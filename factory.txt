factory

ORG 0000H
SJMP MAIN

ORG 0003H
ACALL BOLT_ISR
RETI

STAGE      EQU 30H
BOLTCOUNT  EQU 31H
REQUIRED   EQU 32H

ORG 0030H
MAIN:
    MOV STAGE, #01H
    MOV BOLTCOUNT, #00H
    MOV REQUIRED, #03H
    MOV IE, #10000001B
    SETB IT0
    CLR P1.0
    MOV P1, #00H
    MOV P2, #00H

HERE: 
    MOV A, STAGE
    MOV P1, A
    MOV A, BOLTCOUNT
    MOV P2, A
    SJMP HERE

BOLT_ISR:
    INC BOLTCOUNT
    MOV A, BOLTCOUNT
    CJNE A, REQUIRED, EXIT_ISR
    MOV BOLTCOUNT, #00H
    INC STAGE

    MOV A, STAGE
    CJNE A, #02H, NOT_STAGE2
    MOV REQUIRED, #04H
    SJMP EXIT_ISR

NOT_STAGE2:
    CJNE A, #03H, NOT_STAGE3
    MOV REQUIRED, #05H
    SJMP EXIT_ISR

NOT_STAGE3:
    CJNE A, #04H, EXIT_ISR
    CLR EA
    SETB P1.0

EXIT_ISR:
    RET
END
